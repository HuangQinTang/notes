### 进程&线程

#### 进程

- 在内存中运行的可执行程序的实例我理解为进程，他是cpu资源分配基本单位。

- 当运行一个程序，操作系统会在内存中分配程序需要的资源，进程就是计算机资源分配的基本单位。
- 一个进程拥有的资源有自己的堆、栈、虚存空间（页表）、文件描述符等。
- 从编程的结构看进程，他可以是一个结构体，这个结构体包含，进程编号(pid)，进程的身份标志，进程的状态，新建状态，就绪状态 ，运行状态，阻塞状态，销毁状态，执行优先级，上下文（保存本次执行状态，以便下次继续执行，这个过程就是一个上下文），内存地址。

#### 线程

- 进程的一个执行流叫线程。他是cpu资源执行(调度)的基本单位，即cpu分配时间的单位。
- 线程包含在进程中，多个线程可以共享进程的资源(堆和方法区)，程序计数器和栈是每个线程私有的。程序计数器是一块内存区域，用来记录线程当前要执行的指令地址。栈是用来记录每个线程自己的局部变量的。堆中存放的是当前程序创建的所有对象，方法区存放的是常量和静态变量等信息。



#### 进程和线程的区别

- 进程是资源的拥有者，线程是资源的调度者。进程包含了线程。一般情况下，进程的操作者是操作系统，线程的操作者是程序员。
- 多个进程间不能共享资源，同个进程下的多个线程共享进程资源。
  - 进程所维护的是程序所包含的资源（静态资源），比如：地址空间、打开的文件句柄、文件系统状态，信号处理handler
  - 线程所维护的是程序运行相关的资源（动态资源），如：运行栈、调度相关的控制信息、待处理的信号集...
- 进程的上下文切换，进程创建销毁，开销比线程大。
- 进程更稳定安全
  - 进程有独立的内存空间，一个进程崩溃后，在保护模式下对其他进程不会有影响，而线程只是一个进程中的不同的执行路径，有独立的地址空间，一个进程死掉等于该进程下所有的线程死掉。
  - 所以多进程的程序要比多线程的的程序稳健，但在多进程切换时，耗费资源大，性能较差。



#### 进程/线程之间的亲缘性

- 亲缘性的意思是进程/线程只在某个CPU上运行（多核系统）
- 使用CPU亲缘性的好处：防止进程/线程在CPU的多核间频繁切换，从而避免因切换带来的CPU的L1/L2 cache失效，cache失效会降低程序的性能。



#### 解决一个问题的时候，线程数量是越多越好么？

- 不是，线程切换消耗cpu资源。极端情况下，线程切换消耗的时间还比cpu实际执行所消耗的实际更多。



#### 一个核心没做超线程处理的cpu执行多线程程序有意义么？

- 有的，一个线程执行时并不是一直需要占用cpu计算，有时一些io操作需要等待，等待过程中用不到cpu。



#### 多线程需要注意的

- 内存可见性。java validate关键字，go语法约定的happens-before
- 有序性。为了提高cpu利用率，指令会随机执行，单线程情况下可以保证乱序的指令最终执行结果一致。多线程加锁（内存屏障 ）
- 原子性。加锁，cas解决方案，cas的aba问题(加版本号)，cas本身的原子性保证。



> [进程 线程 协程 各自的概念](https://juejin.cn/post/6950952506176471071?share_token=309a39ea-624a-4066-8b90-2b5818170a95)
>
> [马士兵进程&线程](https://www.bilibili.com/video/BV16541157ZC?p=2&spm_id_from=pageDriver&vd_source=5eb4684f9240445590fb913bac72198d)
